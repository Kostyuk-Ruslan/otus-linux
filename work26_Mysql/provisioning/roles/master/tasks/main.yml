---

  - name: "Add Percona yum repository"
    yum:
      name: https://repo.percona.com/yum/percona-release-latest.noarch.rpm
      state: present
 


  

  - name: Add multiple repositories 
    yum_repository:
      name: epel
      description: EPEL YUM repo
      file: external_repos
      baseurl: https://download.fedoraproject.org/pub/epel/$releasever/$basearch/
      gpgcheck: no


  - name: install epel-release
    yum:
     name:
      - epel-release
     state: latest
    tags: install-packages


  - name: Disable SELinux
    selinux:
      state: disabled


  - name: stop and disable firewalld
    systemd:
      name: firewalld
      state: stopped
      enabled: no


  - name: install package
    yum:
     name:
      - net-tools
      - vim
      - zip
      - unzip
      - traceroute
      - mtr
      - mc
      - tcpdump
      - Percona-Server-server-57
      - python3-PyMySQL
      - python3
      - MySQL-python



  - name: Copy MySQL conf files                                                                                                                                  
    copy:                                                                                                                                                        
      src: conf/conf.d/                                                                                                                                          
      dest: /etc/my.cnf.d/                                                                                                                                       
      owner: root                                                                                                                                                
      group: root                                                                                                                                                
      mode: '0644'     



#  - name: Copy my.cnf
#    template:
#      src: my.cnf.j2
#      dest: /etc/my.cnf
#      owner: root
#      group: root
#      mode: '0600'


  - name: start mysql
    systemd:
      name: mysql
      state: started
      enabled: yes


  - name: 
    shell: cat /var/log/mysqld.log | grep 'root@localhost:' | awk '{print $11}'
    register: current_password
        
  - debug:
      msg:
      - "{{ current_password.stdout_lines }}"
      - "{{ mysql_password }}"

  - name: Set mysql password
    shell: 
      mysql --connect-expired-password -uroot -p'{{ current_password.stdout }}' -e 'ALTER USER USER() IDENTIFIED BY "{{ mysql_password }}"'
    ignore_errors: yes
 


  - name: Create db bet 
    mysql_db:
       login_user: root
       login_password: "{{ mysql_password }}"
       name: bet
       state: present

  - name: Import db bet
    mysql_db:
       login_user: root
       login_password: "{{ mysql_password }}"
       name: bet
       state: import
       target: /etc/my.cnf.d/bet.dmp



  - name: Create db user replication
    mysql_user:
      login_user: root
      login_password: "{{ mysql_password }}"
      name: "repl"
      password: "!OtusLinux2018"
      host: '%'
      priv: '*.*:ALL'
      state: present

   
  - name: Дампим бд 
    shell:  mysqldump --all-databases --triggers --routines --master-data --ignore-table=bet.events_on_demand --ignore-table=bet.v_same_event -uroot -p'B29z3z4z4&&' > master.sql
    
  
  - name: Store master.sql
    fetch:
      src: master.sql
      dest: .  
    
    
    
    
